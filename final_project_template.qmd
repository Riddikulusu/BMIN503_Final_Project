---
title: "Your Title"
subtitle: "BMIN503/EPID600 Final Project"
author: "FirstName LastName"
format: html
editor: visual
number-sections: true
embed-resources: true
---

------------------------------------------------------------------------

Use this template to complete your project throughout the course. Your Final Project presentation will be based on the contents of this document. Replace the title/name above and text below with your own, but keep the headers. Feel free to change the theme and other display settings, although this is not required. I added a new sentence

## Overview {#sec-overview}

Healthcare access is a critical determinant of population health, yet spatial disparities can contribute to uneven health outcomes. This project investigates spatial disparities in healthcare access and their potential impact on mortality rates across Philadelphia districts. The main goal is to examine whether the distribution and accessibility of hospitals are associated with district-level mortality rates, after accounting for demographic and socioeconomic factors, using data from Philadelphia Vital Statistics and PA hospitals. Findings can inform targeted interventions and policy decisions aimed at improving health equity.

## Introduction {#sec-introduction}

Unequal access to hospitals and medical services is a pressing challenge in many cities. Residents in districts with limited access may face longer travel distances, delayed treatment, and ultimately higher morbidity and mortality. These disparities can exacerbate existing health inequalities that are linked to socioeconomic status and other demographic factors. Previous research has shown that greater spatial access to hospitals is associated with incidence of emergency general surgery disease an improved spatial access to care is independently linked to lower in-hospital mortality. However, few studies have quantified how geographic accessibility to hospitals affects all-cause mortality at the district level. This study thus examines whether hospital accessibility is associated with district-level mortality rates in Philadelphia, accounting for demographic and socioeconomic factors, using data from Philadelphia Vital Statistics, and PA hospitals.

This is an interdisciplinary problem encompassing public health, Geographic Information Science (GIS), and health justice. Public health provides the framework for analyzing mortality patterns and methods to control confounding factors. GIS and spatial analytics enable the measurement of hospital accessibility and visualization of spatial inequities, while health justice examines resource distribution and equity issues. Insights from faculty and staff highlighted the importance of using tract-level centroids to calculate accessibility with population weighting, and controlling for social determinants of health (SDOH) to ensure that results are not confounded by underlying socioeconomic factors.

## Methods {#sec-methods}

This study examines the association between hospital accessibility and district-level mortality in Philadelphia. District-level hospital accessibility will be calculated as the population-weighted average of tract-level distances from each tract centroid to the nearest hospital. Descriptive analyses will explore temporal trends in mortality and hospital accessibility to guide modeling choices. Regression models will sequentially adjust for core demographic and socioeconomic confounders, as well as additional social determinants of health (SDOH), with diagnostic checks and sensitivity analyses performed to ensure robust results.

Data sources include Philadelphia Vital Statistics – Mortality (Deaths), Philadelphia Vital Statistics - Population Metrics, Philadelphia Vital Statistics – SDOH and PA Hospitals from OpenDataPhilly. The outcome of interest is the age-adjusted all-cause mortality rate per 100,000 population at the planning-district level. Predictors include hospital count per district and district-level hospital accessibility. Covariates include population density, median household income, number of primary care centers, and additional SDOH indicators.

1.  Load data & data cleaning

```{r}
library(tidyverse)
library(tidymodels)
library(dotwhisker)
library(glmnet)
library(tidycensus)
library(sf)
library(tigris)
library(ggplot2)
library(dplyr)

mortality<-read.csv("Vital_Mortality_PD.csv")
hospital<-st_read("DOH_Hospitals202311/DOH_Hospitals202311.shp")
sdoh<-read.csv("Vital_Social_Determinants_PD.csv")
district<-st_read("Planning_Districts/Planning_Districts.shp")

#population data from acs
years <- 2013:2022
tracts <- map_df(years, function(x) {
  get_acs(
    geography = "tract",
    variables = "B01003_001",  #total population
    year = x,
    survey = "acs5",
    state = "PA",
    county = "Philadelphia",
    geometry = TRUE)|>
    mutate(year = x)
})
tracts<-tracts|>
  select(year,GEOID,estimate,geometry)

mortality<-mortality|>
  filter(METRIC_NAME=="age_adjusted_mortality_rate_per_100k",
         LEADING_CAUSE_DEATH=="All causes",
         ESTIMATE_TYPE=="Final")|>
  select(YEAR,GEOGRAPHY_NAME,METRIC_VALUE)|>
  rename(mortality=METRIC_VALUE,
         district=GEOGRAPHY_NAME)|>
  filter(YEAR %in% 2013:2022)

hospital<-hospital|>
  filter(COUNTY=="Philadelphia")|>
  select(OBJECTID,FACILITY_N,STREET,ZIP_CODE,geometry)|>
  filter(OBJECTID %in% c(81,98,116,120,126,140,155,156,164,170,208,215))#exclude behavioral health, VA, rehabilitation, and specialty hospitals that do not provide acute medical services

sdoh<-sdoh|>
  select(year,geography_name,metric_name,metric_value)|>
  filter(year %in% 2013:2022)
```

2\. Calculate 1)average distance to nearest hospital 2)numbers of hospitals in each district

```{r}
#get the centroid of each tract
tract_centroids <- st_centroid(tracts)
#unify the crs
tract_centroids <- st_transform(tract_centroids, 2272)
hospital <- st_transform(hospital, 2272)
tracts<- st_transform(tract_centroids, 2272)
district<- st_transform(district, 2272)
#get the distance to the nearest hospital for each tract
distance_matrix <- st_distance(tract_centroids, hospital)
nearest_distance <- apply(distance_matrix, 1, min)
tracts$nearest_hospital<-nearest_distance
#match tracts with planning districts
tracts_with_district <- st_join(tract_centroids, district, join = st_within)
tracts$district<-tracts_with_district$DIST_NAME
tracts <- tracts|> drop_na(district) #THE centroid of tract(GEOID 42101006500) is outside any planning district.Its population is about 0.27% of Philadelphia's total population, so i drop it from the analysis.

#calculate district-level hospital accessibility using tract population weights
average_distance <- tracts|>
  group_by(district)|>
  summarise(weighted_distance = sum(estimate * nearest_hospital) / sum(estimate))
mortality<-mortality|>
  left_join(average_distance,by="district")

#count the numbers of hospitals in each district
hospital_with_district <- st_join(hospital, district, join = st_within)|> 
  st_drop_geometry()|>
  rename(district=DIST_NAME)|>
  group_by(district)|>
  count()
mortality<-mortality|>left_join(hospital_with_district, by = "district")|>
  rename(num_of_hos="n")|>
  replace_na(list(num_of_hos=0))


```

3.**(unfinished)** Plot 1) district-level mortality rates in philly from 2013 to 2022, see if there is some trend or the impact of pandemic; 2) an interactive map of hospital accessibility across philly

```{r}
#Plotting district-level mortality rates in philly from 2013 to 2022
mortality |>
  ggplot(aes(x = YEAR, y = mortality, color = district)) +
  geom_line() +
  geom_point() +
  scale_x_continuous(breaks = 2013:2022) +
  theme_minimal() +
  labs(
    title = "Philadelphia District-level Mortality Rate (2013–2022)",
    x = "Year",
    y = "Mortality Rate"
  )

#Plotting district-level population in philly (2013–2022)
tract_population<-tracts|>
  group_by(district,year)|>
  summarise(population = sum(estimate), .groups = "drop")
tract_population|>
  ggplot(aes(x = year, y = population, color = district)) +
  geom_line() +
  geom_point() +
  scale_x_continuous(breaks = 2013:2022) +
  theme_minimal() +
  labs(
    title = "Philadelphia District-level population (2013–2022)",
    x = "Year",
    y = "population"
  )

library(plm)
pdata <- pdata.frame(mortality, index = c("district", "YEAR"))
model <- plm(
  mortality ~ weighted_distance + num_of_hos + factor(YEAR),
  data = pdata,
  model = "within"
)
summary(model)
```

4.  **(unfinished)**some basic analysis between hospital accessibility and sdoh factors and mortality rates (eg. t-test); regression between mortality and number of hospitals and weighted distance to the nearest hospital (seems to be negative?); regression that includes SDOH variables.

```{r}
summary(lm(mortality ~ weighted_distance + num_of_hos, data = mortality))
summary(lm(mortality ~ weighted_distance + num_of_hos+YEAR, data = mortality))
mortality_10<-mortality|>
  group_by(district)|>
  summarise(aver_10=mean(mortality),
            weighted_distance = unique(weighted_distance),
            num_of_hos = unique(num_of_hos))
summary(lm(aver_10 ~ weighted_distance + num_of_hos, data = mortality_10))

mortality_pre_pandemic<-mortality|>
  filter(YEAR %in% 2013:2019)|>
  group_by(district)|>
  summarise(aver_7=mean(mortality),
            weighted_distance = unique(weighted_distance),
            num_of_hos = unique(num_of_hos))
summary(lm(aver_7 ~ weighted_distance + num_of_hos, data =mortality_pre_pandemic))

mortality_post_pandemic<-mortality|>
  filter(YEAR %in% 2020:2022)|>
  group_by(district)|>
  summarise(aver_3=mean(mortality),
            weighted_distance = unique(weighted_distance),
            num_of_hos = unique(num_of_hos))
summary(lm(aver_3 ~ weighted_distance + num_of_hos, data = mortality_post_pandemic))
```

## Results {#sec-results}

Describe your results and include relevant tables, plots, and code/comments used to obtain them. You may refer to the @sec-methods as needed. End with a brief conclusion of your findings related to the question you set out to address. You can include references if you'd like, but this is not required.

## Conclusion

This the conclusion. The @sec-results can be invoked here.

reference

\(1\) McCrum ML, Allen CM, Han J, Iantorno SE, Presson AP, Wan N. Greater spatial access to care is associated with lower mortality for emergency general surgery. J Trauma Acute Care Surg. 2023 Feb 1;94(2):264-272. doi: 10.1097/TA.0000000000003837. Epub 2022 Nov 15. PMID: 36694335; PMCID: PMC10069479.
